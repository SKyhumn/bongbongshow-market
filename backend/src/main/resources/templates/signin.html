<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>봉봉쇼 마켓 - 회원가입/로그인/비번찾기</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 40px; background-color: #f9f9f9; display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;}
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 320px; height: fit-content; }
        h2 { margin-top: 0; color: #333; text-align: center; margin-bottom: 20px; font-size: 1.5em; }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #555; }
        input { width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background-color: #007bff; color: white; margin-top: 10px; }
        .btn-primary:hover { background-color: #0056b3; }

        .btn-secondary { background-color: #6c757d; color: white; font-size: 0.9em; }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-verify { background-color: #28a745; color: white; }
        .btn-verify:hover { background-color: #218838; }

        /* 비활성화 버튼 스타일 */
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .response-box { margin-top: 20px; padding: 10px; background: #eee; border-radius: 4px; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; min-height: 40px;}
    </style>
</head>
<body>

<div class="card">
    <h2>회원가입</h2>
    <div class="input-group">
        <label>이름 (Name)</label>
        <input type="text" id="reg-name" placeholder="홍길동">
    </div>
    <div class="input-group">
        <label>이메일 (Email)</label>
        <input type="email" id="reg-email" placeholder="example@naver.com">
        <input type="text" id="reg-code" placeholder="인증번호 6자리" style="margin-top: 5px;">
        <button id="btn-email-action" class="btn-secondary" onclick="handleRegEmailAction()">인증번호 전송</button>
    </div>
    <div class="input-group">
        <label>비밀번호 (Password)</label>
        <input type="password" id="reg-password" placeholder="비밀번호 입력">
    </div>
    <button class="btn-primary" onclick="signup()">회원가입 완료</button>
</div>

<div class="card">
    <h2>로그인</h2>
    <div class="input-group">
        <label>이메일</label>
        <input type="email" id="login-email">
    </div>
    <div class="input-group">
        <label>비밀번호</label>
        <input type="password" id="login-password">
    </div>
    <button class="btn-primary" onclick="signin()">로그인</button>
    <div class="response-box" id="login-result">로그인 결과 대기중...</div>
</div>

<div class="card">
    <h2>비밀번호 재설정</h2>
    <div class="input-group">
        <label>가입된 이메일</label>
        <input type="email" id="reset-email" placeholder="example@naver.com">
        <input type="text" id="reset-code" placeholder="인증번호 6자리" style="margin-top: 5px;">
        <button id="btn-reset-email-action" class="btn-secondary" onclick="handleResetEmailAction()">인증번호 전송</button>
    </div>
    <div class="input-group">
        <label>새 비밀번호</label>
        <input type="password" id="reset-new-password" placeholder="새로운 비밀번호">
    </div>
    <button class="btn-primary" onclick="resetPassword()">비밀번호 변경</button>
</div>

<script>
    const BASE_URL = '/api/public';

    // ==========================================
    // [1] 회원가입 관련 로직
    // ==========================================
    let isRegVerifyMode = false; // 회원가입용 상태

    async function handleRegEmailAction() {
        const email = document.getElementById('reg-email').value;
        const codeInput = document.getElementById('reg-code');
        const btn = document.getElementById('btn-email-action');

        if (!email) { alert("이메일을 입력해주세요."); return; }

        if (!isRegVerifyMode) {
            // [회원가입] 인증번호 전송
            callApi('/send-code', { email: email }, btn, () => {
                alert("인증코드가 발송되었습니다.");
                isRegVerifyMode = true;
                btn.innerText = "인증 확인";
                btn.className = "btn-verify";
                codeInput.focus();
            });
        } else {
            // [회원가입] 인증번호 확인
            verifyCodeProcess(email, codeInput.value, btn, () => {
                btn.innerText = "인증 완료";
                btn.disabled = true;
            }, () => {
                isRegVerifyMode = false;
                btn.innerText = "인증번호 전송";
                btn.className = "btn-secondary";
            });
        }
    }

    async function signup() {
        const data = {
            email: document.getElementById('reg-email').value,
            password: document.getElementById('reg-password').value,
            name: document.getElementById('reg-name').value
        };
        if(!data.email || !data.password || !data.name) { alert("모든 필드를 입력하세요."); return; }

        const res = await fetchPost('/signup', data);
        if(res.ok) {
            alert("회원가입 성공!");
            window.location.reload();
        } else {
            alert("가입 실패: " + await res.text());
        }
    }

    // ==========================================
    // [2] 비밀번호 재설정 관련 로직 (추가됨)
    // ==========================================
    let isResetVerifyMode = false; // 재설정용 상태

    async function handleResetEmailAction() {
        const email = document.getElementById('reset-email').value;
        const codeInput = document.getElementById('reset-code');
        const btn = document.getElementById('btn-reset-email-action');

        if (!email) { alert("이메일을 입력해주세요."); return; }

        if (!isResetVerifyMode) {
            // [재설정] 인증번호 전송 (API 엔드포인트가 다름: /send-reset-code)
            callApi('/send-reset-code', { email: email }, btn, () => {
                alert("재설정용 인증코드가 발송되었습니다.");
                isResetVerifyMode = true;
                btn.innerText = "인증 확인";
                btn.className = "btn-verify";
                codeInput.focus();
            });
        } else {
            // [재설정] 인증번호 확인 (회원가입과 같은 /verify-code 사용)
            verifyCodeProcess(email, codeInput.value, btn, () => {
                btn.innerText = "인증 완료";
                btn.disabled = true;
            }, () => {
                isResetVerifyMode = false;
                btn.innerText = "인증번호 전송";
                btn.className = "btn-secondary";
            });
        }
    }

    async function resetPassword() {
        const data = {
            email: document.getElementById('reset-email').value,
            newPassword: document.getElementById('reset-new-password').value
        };
        if(!data.email || !data.newPassword) { alert("이메일과 새 비밀번호를 입력하세요."); return; }

        const res = await fetchPost('/reset-password', data);
        if(res.ok) {
            alert("비밀번호가 변경되었습니다. 로그인해주세요.");
            // 입력창 초기화
            document.getElementById('reset-new-password').value = "";
            document.getElementById('reset-code').value = "";
            document.getElementById('btn-reset-email-action').disabled = false;
            document.getElementById('btn-reset-email-action').innerText = "인증번호 전송";
            document.getElementById('btn-reset-email-action').className = "btn-secondary";
            isResetVerifyMode = false;
        } else {
            alert("변경 실패: " + await res.text());
        }
    }


    // ==========================================
    // [3] 로그인 로직
    // ==========================================
    async function signin() {
        const data = {
            email: document.getElementById('login-email').value,
            password: document.getElementById('login-password').value
        };
        const res = await fetchPost('/signin', data);
        if(res.ok) {
            alert("로그인 성공!");
            window.location.href = '/hello';
        } else {
            alert("로그인 실패: 아이디/비번 확인");
        }
    }


    // ==========================================
    // [4] 공통 유틸 함수 (코드 중복 제거)
    // ==========================================

    // API 호출 헬퍼
    async function fetchPost(url, data) {
        try {
            return await fetch(BASE_URL + url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } catch(e) {
            console.error(e);
            throw e;
        }
    }

    // 이메일 전송 버튼 처리 헬퍼
    async function callApi(endpoint, data, btnElement, onSuccess) {
        try {
            btnElement.disabled = true;
            const originalText = btnElement.innerText;
            btnElement.innerText = "처리 중...";

            const res = await fetchPost(endpoint, data);

            if (res.ok) {
                onSuccess();
            } else {
                alert("실패: " + await res.text());
                btnElement.innerText = originalText; // 복구
            }
        } catch (e) {
            alert("서버 오류");
        } finally {
            if(btnElement.innerText !== "인증 완료") { // 완료된게 아니면 활성화
                btnElement.disabled = false;
            }
        }
    }

    // 인증번호 검증 처리 헬퍼
    async function verifyCodeProcess(email, code, btnElement, onSuccess, onFail) {
        if (!code) { alert("인증번호를 입력해주세요."); return; }

        try {
            const res = await fetchPost('/verify-code', { email: email, code: code });
            if (res.ok) {
                alert("인증 성공!");
                onSuccess();
            } else {
                alert("인증 실패: 코드를 확인해주세요.");
                onFail();
            }
        } catch (e) {
            alert("오류 발생");
        }
    }
</script>
</body>
</html>